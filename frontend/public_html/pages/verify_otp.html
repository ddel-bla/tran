<div class="login-container">
    <div class="login-box">
        <h2 class="text-center" data-key="verify_otp_title">Verificación de Seguridad</h2>
        <p class="text-center text-muted" data-key="verify_otp_message">Introduce el código de verificación de tu aplicación de autenticación</p>

        <div id="otp-message" class="alert alert-info mb-3" style="display: none;"></div>

        <form id="otpForm">
            <div class="mb-3 login-elem">
                <label for="otpCode" class="form-label" data-key="otp_code_label">Código de verificación</label>
                <input type="text" class="register-form-control" id="otpCode" placeholder="Código de 6 dígitos" 
                       required pattern="[0-9]{6}" autocomplete="one-time-code">
                <small class="text-muted" data-key="otp_help_text">Introduce el código de 6 dígitos generado por tu aplicación autenticadora</small>
            </div>

            <input type="hidden" id="tempToken" value="">

            <button type="button" class="btn btn-dark w-100" onclick="verifyOtp()" data-key="verify_button">Verificar</button>
        </form>

        <p class="text-center mt-3">
            <a href="#" onclick="PageManager.load('login')" data-key="back_to_login">Volver al inicio de sesión</a>
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener el token temporal de localStorage
    const tempToken = localStorage.getItem('temp_token');
    if (tempToken) {
        document.getElementById('tempToken').value = tempToken;
    } else {
        // Si no hay token temporal, redirigir al login
        PageManager.load('login');
    }
});

async function verifyOtp() {
    const otpCode = document.getElementById('otpCode').value.trim();
    const tempToken = document.getElementById('tempToken').value;
    const messageElement = document.getElementById('otp-message');
    
    if (!otpCode || otpCode.length !== 6 || !/^\d+$/.test(otpCode)) {
        showMessage(messageElement, "El código debe contener 6 dígitos", "danger");
        return;
    }
    
    if (!tempToken) {
        showMessage(messageElement, "Error de autenticación. Inicia sesión nuevamente.", "danger");
        setTimeout(() => PageManager.load('login'), 2000);
        return;
    }
    
    try {
        const csrfToken = await getCsrfToken();
        
        const response = await fetch("https://localhost:8441/api/auth/verify-otp", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            credentials: "include",
            body: JSON.stringify({ 
                temp_token: tempToken,
                otp_code: otpCode
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showMessage(messageElement, "Autenticación completada exitosamente", "success");
            
            // Guardar el token JWT y los datos del usuario
            localStorage.setItem("jwt_backend2", data.token);
            localStorage.setItem("username_backend2", data.username);
            localStorage.setItem("image_url_backend2", data.image_url || "https://i.imgur.com/DP2aShH.png");
            
            // Limpiar el token temporal
            localStorage.removeItem("temp_token");
            
            // Redireccionar al juego
            setTimeout(() => {
                PageManager.load('game');
                updateNavbar();
            }, 1500);
        } else {
            showMessage(messageElement, data.error || "Error de verificación", "danger");
        }
    } catch (error) {
        console.error("Error en la verificación:", error);
        showMessage(messageElement, "Error en la comunicación con el servidor", "danger");
    }
}

function showMessage(element, message, type) {
    element.textContent = message;
    element.className = `alert alert-${type} mb-3`;
    element.style.display = "block";
}
</script>